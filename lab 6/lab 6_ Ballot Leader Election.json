{"paragraphs":[{"text":"%md\n\n### Ballot Leader Election\n\nIn this programming assignment you will have to complete the implementation of a special Leader Election Algorithm with monotonically increasing ballots.\n\nWhen you are done you simply have to export your notebook and then upload it in the \"Programming Exercise 1\" page.\n\n**Things to Remember**:\n1. Basic components such as `PerfectLink` are already provided. No need to implement them.\n2. Execute the imports defined below **before** compiling your component implementations.\n3. We recommend making use of the component state and internal messages we have provided, if any, to complete the implementation logic.\n4. You can always print messages to the output log, from within handlers to see what happens during the simulation. e.g. `println(s\"Process $self delivers message $msg\");`\n5. Remember that during the simulation check you can print and observe the simulation time, i.e. with `System.currentTimeMillis()`.\n5. Do not forget to run the checker code block after each component implementation to ensure that all properties are satisfied **before** exporting and submitting the notebook.\n6. You can always restart the Kompics Interpreter to start fresh (Interpreter→KompicsInterpreter→Click Restart)\n\nGood luck! :)","dateUpdated":"2021-02-28T17:35:56+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","colWidth":12,"editorHide":true,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1614533756260_-2093657096","id":"20160927-134633_1462429338","dateCreated":"2021-02-28T17:35:56+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:440"},{"text":"\nimport se.kth.edx.id2203.core.ExercisePrimitives.AddressUtils._\nimport se.kth.edx.id2203.core.ExercisePrimitives.AddressUtils\nimport se.kth.edx.id2203.core.Ports._\nimport se.kth.edx.id2203.validation._\nimport se.kth.edx.id2203.validation.checkBallotLE\nimport se.sics.kompics.network._\nimport se.sics.kompics.sl._\nimport se.sics.kompics.timer.{ScheduleTimeout, Timeout, Timer}\nimport se.sics.kompics.{KompicsEvent, Start}\n\nimport scala.collection.mutable;\n","user":"anonymous","dateUpdated":"2021-03-02T16:11:42+0000","config":{"lineNumbers":false,"tableHide":true,"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","colWidth":12,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"import se.kth.edx.id2203.core.ExercisePrimitives.AddressUtils._<br />import se.kth.edx.id2203.core.ExercisePrimitives.AddressUtils<br />import se.kth.edx.id2203.core.Ports._<br />import se.kth.edx.id2203.validation._<br />import se.kth.edx.id2203.validation.checkBallotLE<br />import se.sics.kompics.network._<br />import se.sics.kompics.sl._<br />import se.sics.kompics.timer.{ScheduleTimeout, Timeout, Timer}<br />import se.sics.kompics.{KompicsEvent, Start}<br />import scala.collection.mutable<br />"}]},"apps":[],"jobName":"paragraph_1614533756294_-2006703844","id":"20160830-154917_187608468","dateCreated":"2021-02-28T17:35:56+0000","dateStarted":"2021-03-02T16:11:42+0000","dateFinished":"2021-03-02T16:11:45+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:441"},{"text":"%md\n\n## Gossip-Based Ballot Leader Election ##\n\nA Ballot Leader Election Abstraction, in Kompics terms, is a simple component that **provides** the following port *(already imported in the notebook)*.\n\n    class BallotLeaderElection extends Port {\n        indication[BLE_Leader];\n    }\n  \n\nA **BallotLeaderElection** component should indicate to subscribers of its port that a new leader is elected (along with a ballot) with a `BLE_Leader` message that contains the address of the leader the ballot number (already provided):\n\n    case class BLE_Leader(leader: Address, ballot: Long) extends KompicsEvent;\n\nThe following properties define the expected behavior of a consensus abstraction more specifically:\n\n1. **Completeness**: *Eventually every correct process elects some correct process as long as a majority is correct*\n2. **Eventual Agreement**: *Eventually no two correct processes elect different correct processes.*\n3. **Monotonic Unique Ballots**: *Ballot numbers of consecutively elected processes should be unique and monotonically increasing.*\n    \nThe recommended algorithm to use is the the one we call \"Gossip Leader Election\" which elects the top process using a majority of gossiping messages.\nYou can find the algorithm in the following  <a href=\"https://courses.edx.org/asset-v1:KTHx+ID2203.2x+2016T4+type@asset+block@ble.pdf\" target=\"_blank\">document</a>.\n","dateUpdated":"2021-02-28T17:35:56+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","colWidth":12,"editorHide":true,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1614533756295_-2007088593","id":"20160930-115754_781424547","dateCreated":"2021-02-28T17:35:56+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:442"},{"text":"\n//Provided Primitives to use in your implementation\n\n  case class CheckTimeout(timeout: ScheduleTimeout) extends Timeout(timeout);\n\n  case class HeartbeatReq(round: Long, highestBallot: Long) extends KompicsEvent;\n\n  case class HeartbeatResp(round: Long, ballot: Long) extends KompicsEvent;\n\n  private val ballotOne = 0x0100000000l;\n  \n  def ballotFromNAddress(n: Int, adr: Address): Long = {\n    val nBytes = com.google.common.primitives.Ints.toByteArray(n);\n    val addrBytes = com.google.common.primitives.Ints.toByteArray(adr.hashCode());\n    val bytes = nBytes ++ addrBytes;\n    val r = com.google.common.primitives.Longs.fromByteArray(bytes);\n    assert(r > 0); // should not produce negative numbers!\n    r\n  }\n\n  def incrementBallotBy(ballot: Long, inc: Int): Long = {\n    ballot + inc.toLong * ballotOne\n  }\n\n  private def incrementBallot(ballot: Long): Long = {\n    ballot + ballotOne\n  }","user":"anonymous","dateUpdated":"2021-03-02T16:11:47+0000","config":{"tableHide":true,"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","colWidth":12,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"defined class CheckTimeout<br />defined class HeartbeatReq<br />defined class HeartbeatResp<br />ballotFromNAddress: (n: Int, adr: se.sics.kompics.network.Address)Long<br />incrementBallotBy: (ballot: Long, inc: Int)Long<br />"}]},"apps":[],"jobName":"paragraph_1614533756296_-2009012338","id":"20160830-154940_1300846994","dateCreated":"2021-02-28T17:35:56+0000","dateStarted":"2021-03-02T16:11:47+0000","dateFinished":"2021-03-02T16:11:53+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:443"},{"text":"\nclass GossipLeaderElection(init: Init[GossipLeaderElection]) extends ComponentDefinition {\n\n  val ble = provides[BallotLeaderElection];\n  val pl = requires[PerfectLink];\n  val timer = requires[Timer];\n\n  val self = init match {\n    case Init(s: Address) => s\n  }\n  val topology = cfg.getValue[List[Address]](\"ble.simulation.topology\");\n  val delta = cfg.getValue[Long](\"ble.simulation.delay\");\n  val majority = (topology.size / 2) + 1;\n\n  private var period = cfg.getValue[Long](\"ble.simulation.delay\");\n  private val ballots = mutable.Map.empty[Address, Long];\n\n  private var round = 0l;\n  private var ballot = ballotFromNAddress(0, self);\n\n  private var leader: Option[(Long, Address)] = None;\n  private var highestBallot: Long = ballot;\n\n  private def startTimer(delay: Long): Unit = {\n    val scheduledTimeout = new ScheduleTimeout(period);\n    scheduledTimeout.setTimeoutEvent(CheckTimeout(scheduledTimeout));\n    trigger(scheduledTimeout -> timer);\n  }\n\n  private def makeLeader(topProcess: (Long, Address)) {\n    /* INSERT YOUR CODE HERE */\n    leader = Some(topProcess);\n  }\n\n  private def checkLeader() {\n       /* INSERT YOUR CODE HERE */\n      var topProcess = self;\n      var topBallot = ballot;\n      \n      \n    //   val temp = (self, ballot);\n      ballots += (self->ballot);\n      //get top ballot\n      for(b <- ballots){\n          if(b._2 > topBallot){\n              topBallot = b._2;\n              topProcess = b._1;\n          }\n      }\n      var top = (topBallot, topProcess);\n      if(topBallot < highestBallot){\n          while(ballot <= highestBallot){\n              ballot = incrementBallotBy(ballot, 1);\n          }\n          leader = None;\n      }else{\n          if(Some(top) != leader ){\n              highestBallot = topBallot;\n              makeLeader((topBallot, topProcess));\n              trigger(BLE_Leader(topProcess, topBallot)->ble);\n          }\n      }\n       \n  }\n\n  ctrl uponEvent {\n    case _: Start =>  {\n      startTimer(period);\n    }\n  }\n\n  timer uponEvent {\n    case CheckTimeout(_) => {\n    /* INSERT YOUR CODE HERE */\n    if(ballots.size + 1 >= majority){\n        checkLeader();\n    }\n    ballots.clear;\n    round = round + 1;\n    for(p <- topology){\n        if(p != self){\n            trigger(PL_Send(p, HeartbeatReq(round, highestBallot))->pl);\n        }\n    }\n    startTimer(period);\n  }\n  }\n\n  pl uponEvent {\n    case PL_Deliver(src, HeartbeatReq(r, hb)) => {\n         /* INSERT YOUR CODE HERE */\n         if(hb > highestBallot){\n             highestBallot = hb;\n         }\n         trigger(PL_Send(src, HeartbeatResp(r,ballot))->pl);\n    }\n    case PL_Deliver(src, HeartbeatResp(r, b)) => {\n      /* INSERT YOUR CODE HERE */\n      if(r == round){\n          ballots += (src-> b);\n      }else{\n            period = period + delta; \n      }\n    }\n  }\n}","user":"anonymous","dateUpdated":"2021-03-02T16:14:06+0000","config":{"lineNumbers":true,"tableHide":false,"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","colWidth":12,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"defined class GossipLeaderElection<br />"}]},"apps":[],"jobName":"paragraph_1614533756297_-2009397087","id":"20160830-154952_592749615","dateCreated":"2021-02-28T17:35:56+0000","dateStarted":"2021-03-02T16:14:06+0000","dateFinished":"2021-03-02T16:14:07+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:444"},{"text":"checkBallotLE[GossipLeaderElection]();","user":"anonymous","dateUpdated":"2021-03-02T16:14:11+0000","config":{"tableHide":false,"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","colWidth":12,"fontSize":9,"results":[{"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}}}],"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<br />Your submission has been locally simulated and validated.<br /><br /><a href=\"\\static\\log.txt\" target=\"_blank\">Click Here</a> to view the output of the simulation.<br /><style type=\"text/css\">.tg  {border-collapse:collapse;border-spacing:0;border-color:#aabcfe;}.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#aabcfe;color:#669;background-color:#e8edff;}.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#aabcfe;color:#039;background-color:#b9c9fe;}.tg .tg-mb3i{background-color:#D2E4FC;text-align:right;vertical-align:top}.tg .tg-lqy6{text-align:right;vertical-align:top}.tg .tg-vlnx{background-color:#3071a9;color:#ffffff;text-align:center;vertical-align:top}.tg .tg-6k2t{background-color:#D2E4FC;vertical-align:top}.tg tg-6k2l{background-color:#ffb3b3;vertical-align:top}.tg .tg-yw4l{vertical-align:top}</style><table class=\"tg\">  <tr>    <th class=\"tg-vlnx\" colspan=\"3\">Correction Results</th>  </tr><br /><tr>    <td class=\"tg-6k2t\">PASSED</td> <td class=\"tg-6k2t\">Completeness</td> <td class=\"tg-6k2t\">✔: Eventually every correct process elects some correct process as long as a majority is correct<br></td>  </tr>  <br /><tr>    <td class=\"tg-6k2t\">PASSED</td> <td class=\"tg-6k2t\">Eventual Agreement</td> <td class=\"tg-6k2t\">✔: Eventually no two correct processes elect different correct processes<br></td>  </tr>  <br /><tr>    <td class=\"tg-6k2t\">PASSED</td> <td class=\"tg-6k2t\">Monotonic Unique Ballots</td> <td class=\"tg-6k2t\">✔: Ballot numbers of consecutively elected processes should be unique and monotonically increasing<br></td>  </tr>  <br /></table><br />Final Comments<br />**************<br />Congratulations! Your implementation of the 'Ballot Leader Election' satisfies all properties! <br />A unique token has been generated for your submission right below. Please do not edit. <br /><br />{\"gradingToken\":[45,45,45,45,45,66,69,71,73,78,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10,86,101,114,115,105,111,110,58,32,66,67,80,71,32,118,49,46,53,53,10,10,104,81,73,77,65,57,79,116,77,118,84,69,98,74,49,102,65,81,47,47,97,56,53,116,114,109,50,106,120,52,88,109,84,104,55,72,106,115,43,43,115,79,68,76,105,77,87,67,71,97,108,71,101,78,69,89,47,87,50,43,120,87,107,114,10,78,54,111,114,97,122,110,88,109,67,115,114,53,75,85,112,68,69,116,105,107,117,122,108,120,83,74,80,66,54,106,100,113,68,98,112,107,100,113,88,119,120,82,55,112,121,102,54,73,81,112,79,75,104,66,55,105,71,54,108,82,111,103,70,10,119,113,53,114,76,106,79,80,67,104,115,88,52,51,43,66,56,54,84,74,57,67,97,70,108,70,108,101,66,104,47,72,76,55,85,57,66,98,52,81,65,67,100,88,88,105,109,51,50,68,85,74,122,52,65,98,52,122,88,69,100,47,52,47,10,80,55,75,102,80,101,99,110,51,57,109,99,47,78,90,47,50,105,53,50,122,79,97,65,76,117,103,73,121,84,80,112,47,120,82,100,54,104,68,105,78,115,68,98,104,43,81,67,78,49,119,66,51,81,77,76,116,90,118,120,71,57,81,68,10,75,77,57,47,70,121,111,120,111,75,109,53,76,48,99,77,100,101,68,77,57,70,112,88,116,115,107,86,55,79,85,70,50,103,109,101,73,119,47,84,110,57,98,82,89,67,85,54,104,89,68,116,77,121,81,70,72,43,66,108,112,69,86,51,10,88,73,84,53,57,85,86,99,71,81,83,57,76,82,111,57,110,104,80,120,50,116,79,72,53,72,49,108,115,117,112,82,100,75,116,119,52,102,90,119,99,104,106,119,52,66,98,81,74,82,111,83,69,82,51,85,67,71,99,90,51,69,76,86,10,88,114,82,75,73,48,97,98,104,115,117,43,79,75,89,110,51,65,78,112,109,77,97,83,85,109,84,107,52,75,120,65,114,87,74,55,55,74,109,114,108,77,71,90,101,48,81,102,118,76,69,122,107,80,56,98,70,85,83,99,104,55,82,97,10,122,75,99,121,51,113,52,55,72,122,50,78,84,65,113,54,119,79,102,67,104,78,122,72,48,85,89,50,75,85,51,51,78,83,115,68,119,80,107,110,112,103,80,90,119,114,116,115,75,50,76,102,108,65,57,72,106,122,85,74,43,48,66,50,10,90,55,85,79,119,98,90,97,100,110,103,56,105,115,100,119,48,50,89,53,79,115,111,88,57,49,116,85,121,90,89,110,110,99,107,55,78,48,49,67,79,74,97,75,89,50,119,72,106,118,79,105,103,103,104,103,102,101,85,118,102,81,81,52,10,118,89,117,79,106,74,111,103,67,109,54,56,122,48,112,56,54,51,52,104,49,78,52,76,68,121,66,101,73,83,78,118,55,111,73,105,120,69,116,105,87,118,65,117,70,75,120,118,90,48,102,114,52,118,110,79,88,53,114,74,120,102,97,67,10,82,112,84,77,57,99,100,48,73,117,105,118,115,102,51,119,71,52,73,100,97,104,88,114,103,115,105,57,88,102,105,80,54,67,121,69,56,67,117,65,72,89,112,70,101,79,116,55,75,80,75,54,88,113,104,113,47,86,49,111,72,72,51,83,10,119,68,111,66,115,77,65,43,56,88,102,88,122,56,57,89,52,108,72,70,65,78,81,57,105,78,76,110,79,119,47,66,84,97,110,73,48,86,72,122,52,87,116,102,77,73,116,55,107,120,106,122,51,115,51,84,55,99,81,70,83,89,79,105,10,80,67,109,71,43,79,81,102,88,109,113,114,78,77,118,74,78,79,89,82,111,87,72,115,77,72,109,72,114,118,97,67,54,107,121,102,107,77,56,67,90,103,114,75,103,85,82,109,56,54,99,74,86,70,55,76,114,102,77,76,81,66,47,70,10,97,113,72,88,110,74,77,120,118,65,57,101,50,100,65,109,73,70,70,103,97,80,119,53,71,116,50,122,100,90,118,84,69,76,47,43,53,79,76,111,89,76,120,78,78,43,85,101,99,78,88,97,107,114,47,112,74,110,109,43,89,50,48,52,10,119,120,47,102,107,82,70,87,109,100,107,54,110,67,119,108,97,54,49,65,110,47,104,56,73,114,87,111,103,104,52,87,112,49,103,70,65,76,78,73,55,82,103,66,47,74,113,76,48,108,89,102,73,83,74,109,85,120,57,73,73,80,105,82,10,66,71,51,71,79,100,99,43,114,66,106,49,53,111,115,99,101,47,79,72,120,54,82,69,88,72,68,84,111,77,98,54,68,84,73,76,47,83,50,83,88,50,113,51,43,99,114,72,104,106,113,83,105,54,122,103,47,67,111,118,113,81,110,112,10,73,101,84,99,77,47,54,122,72,48,57,66,78,89,122,86,10,61,54,118,83,117,10,45,45,45,45,45,69,78,68,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10]}<br />res2: Boolean = true<br />"}]},"apps":[],"jobName":"paragraph_1614533756298_-2008242840","id":"20160830-155009_392534435","dateCreated":"2021-02-28T17:35:56+0000","dateStarted":"2021-03-02T16:14:11+0000","dateFinished":"2021-03-02T16:14:20+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:445"},{"dateUpdated":"2021-02-28T17:35:56+0000","config":{"tableHide":false,"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","colWidth":12,"fontSize":9,"results":[],"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1614533756299_-2008627589","id":"20160830-155043_337959288","dateCreated":"2021-02-28T17:35:56+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:446"}],"name":"lab 6: Ballot Leader Election","id":"2G1PH5HBA","angularObjects":{"2BKQCVH92:shared_process":[],"2CVXXPNWV:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}